// ========== ‡§Æ‡•à‡§ü‡•ç‡§∞‡§ø‡§ï‡•ç‡§∏ ‡§ï‡•â‡§®‡•ç‡§´‡§ø‡§ó‡§∞‡•á‡§∂‡§® ==========
const configs = [
    { name: "S30", levels: [1, 2, 4, 8, 16], price: 20 },
    { name: "S14", levels: [1, 2, 4, 8], price: 160 },
    { name: "S6", levels: [1, 2, 4], price: 800 },
    { name: "S3", levels: [1, 3], price: 2000 },
    { name: "S2", levels: [1, 2], price: 4000 },
    { name: "S30 PRO", levels: [1, 2, 4, 8, 16], price: 2000 },
    { name: "S14 PRO", levels: [1, 2, 4, 8], price: 6000 },
    { name: "S6 PRO", levels: [1, 2, 4], price: 12000 },
    { name: "S3 PRO", levels: [1, 3], price: 18000 },
    { name: "S2 PRO", levels: [1, 2], price: 27000 }
];

// ========== ‡§á‡§®‡§ï‡§Æ ‡§∞‡•Ç‡§≤‡•ç‡§∏ ==========
const incomeRules = {
    "S30": [0, 0, 25, 25, 50],
    "S14": [0, 0, 20, 80],
    "S6": [0, 0, 100],
    "S3": [0, 100],
    "S2": [0, 100]
};

// PRO versions
incomeRules["S30 PRO"] = incomeRules["S30"];
incomeRules["S14 PRO"] = incomeRules["S14"];
incomeRules["S6 PRO"] = incomeRules["S6"];
incomeRules["S3 PRO"] = incomeRules["S3"];
incomeRules["S2 PRO"] = incomeRules["S2"];

// ========== ‡§è‡§∏‡•á‡§ü ‡§á‡§Æ‡•ã‡§ú‡•Ä ‡§î‡§∞ ‡§®‡§æ‡§Æ ==========
const assetEmojis = {
    'bgw': 'üí∞',
    'gold': 'ü™ô',
    'silver': 'üíø',
    'platinum': 'üíé'
};

const assetNames = {
    'bgw': 'BGW',
    'gold': 'Gold',
    'silver': 'Silver',
    'platinum': 'Platinum'
};

// ========== ‡§ó‡•ç‡§≤‡•ã‡§¨‡§≤ ‡§µ‡•á‡§∞‡§ø‡§è‡§¨‡§≤ ==========
let boxes = [];
let totalIncome = 0;
let currentSlotToBuy = 0;
let pendingBuySlot = null;
let currentExtraSlot = null;
let selectedPopupAsset = null;
let selectedExtraAsset = null;
let currentTheme = 'dark';

// ========== DOM CONTENT LOADED ==========
document.addEventListener('DOMContentLoaded', function() {
    // Photo Upload
    const photoArea = document.getElementById('photoArea');
    const photoUpload = document.getElementById('photoUpload');
    
    photoArea.addEventListener('click', () => photoUpload.click());
    
    photoUpload.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(event) {
                const placeholder = photoArea.querySelector('.photo-placeholder');
                if (placeholder) placeholder.remove();
                
                let img = photoArea.querySelector('img');
                if (!img) {
                    img = document.createElement('img');
                    photoArea.appendChild(img);
                }
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Open/Close System
    const openBtn = document.getElementById('openSystemBtn');
    const nftCard = document.getElementById('nftCard');
    const systemPage = document.getElementById('systemPage');
    const closeBtn = document.getElementById('closeSystemBtn');
    
    openBtn.addEventListener('click', () => {
        nftCard.style.display = 'none';
        systemPage.style.display = 'block';
    });
    
    closeBtn.addEventListener('click', () => {
        nftCard.style.display = 'block';
        systemPage.style.display = 'none';
    });
    
    // Settings
    const settingsBtn = document.getElementById('settingsBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const closeSettingsBtn = document.getElementById('closeSettingsBtn');
    const darkThemeBtn = document.getElementById('darkThemeBtn');
    const lightThemeBtn = document.getElementById('lightThemeBtn');
    const darkCheck = document.getElementById('darkCheck');
    const lightCheck = document.getElementById('lightCheck');
    
    settingsBtn.addEventListener('click', () => settingsPanel.style.display = 'block');
    closeSettingsBtn.addEventListener('click', () => settingsPanel.style.display = 'none');
    
    darkThemeBtn.addEventListener('click', () => {
        setTheme('dark');
        darkCheck.style.opacity = '1';
        lightCheck.style.opacity = '0';
        settingsPanel.style.display = 'none';
    });
    
    lightThemeBtn.addEventListener('click', () => {
        setTheme('light');
        darkCheck.style.opacity = '0';
        lightCheck.style.opacity = '1';
        settingsPanel.style.display = 'none';
    });
    
    // Assets Popup
    const assetsBtn = document.getElementById('assetsBtn');
    const assetPopup = document.getElementById('assetMiningPopup');
    const closeAssetsBtn = document.getElementById('closeAssetsBtn');
    const closeAssetsPopup = document.getElementById('closeAssetsPopup');
    
    assetsBtn.addEventListener('click', () => {
        updateAssetsPopup();
        assetPopup.style.display = 'block';
    });
    
    closeAssetsBtn.addEventListener('click', () => assetPopup.style.display = 'none');
    closeAssetsPopup.addEventListener('click', () => assetPopup.style.display = 'none');
    
    // Initialize
    initializeMatrices();
    setInterval(updateNFTStats, 1000);
});

// ========== ‡§•‡•Ä‡§Æ ‡§∏‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ==========
function setTheme(theme) {
    currentTheme = theme;
    const body = document.body;
    const settingsPanel = document.getElementById('settingsPanel');
    const assetPopup = document.getElementById('assetMiningPopup');
    
    body.classList.remove('dark-mode', 'light-mode');
    settingsPanel.classList.remove('dark-mode', 'light-mode');
    assetPopup.classList.remove('dark-mode', 'light-mode');
    
    if (theme === 'dark') {
        body.classList.add('dark-mode');
        settingsPanel.classList.add('dark-mode');
        assetPopup.classList.add('dark-mode');
    } else {
        body.classList.add('light-mode');
        settingsPanel.classList.add('light-mode');
        assetPopup.classList.add('light-mode');
    }
}

// ========== ‡§è‡§∏‡•á‡§ü‡•ç‡§∏ ‡§™‡•â‡§™‡§Ö‡§™ ‡§Ö‡§™‡§°‡•á‡§ü ==========
function updateAssetsPopup() {
    const assetsList = document.getElementById('assetsMiningList');
    let html = '';
    
    boxes.forEach(box => {
        if (box.activated) {
            let mainAmount = (!box.mainAsset || box.mainAsset === 'bgw') ? box.bgw : box.assetAmount;
            let mainName = (!box.mainAsset || box.mainAsset === 'bgw') ? 'BGW' : assetNames[box.mainAsset];
            
            let status = box.isActiveInNFT ? '‚úÖ Active' : '‚è≥ Not Active';
            
            html += `<div class="asset-mining-item">`;
            html += `<div class="asset-details">`;
            html += `<div class="asset-name-slot">${box.name} - ${mainName} <span style="font-size:9px; color:#888;">${status}</span></div>`;
            html += `<div class="asset-amount">${mainAmount.toFixed(4)}</div>`;
            html += `</div></div>`;
            
            if (box.extraAsset) {
                let extraAmount = 0;
                let extraName = '';
                
                if (box.extraAsset === 'bgw') {
                    extraAmount = box.bgw;
                    extraName = 'BGW';
                } else if (box.extraAsset === box.mainAsset) {
                    extraAmount = box.assetAmount;
                    extraName = assetNames[box.extraAsset];
                } else {
                    extraAmount = box.extraAmount;
                    extraName = assetNames[box.extraAsset];
                }
                
                html += `<div class="asset-mining-item" style="margin-left: 15px;">`;
                html += `<div class="asset-details">`;
                html += `<div class="asset-name-slot">${box.name} - ${extraName} (Extra)</div>`;
                html += `<div class="asset-amount">${extraAmount.toFixed(4)}</div>`;
                html += `</div></div>`;
            }
        }
    });
    
    if (html === '') html = '<div class="loading-assets">‡§ï‡•ã‡§à ‡§Æ‡§æ‡§á‡§®‡§ø‡§Ç‡§ó ‡§®‡§π‡•Ä‡§Ç</div>';
    assetsList.innerHTML = html;
}

// ========== Slots Preview ‡§Ö‡§™‡§°‡•á‡§ü ‡§ï‡§∞‡•á‡§Ç ==========
function updateSlotsPreview() {
    const slotsPreview = document.getElementById('slotsPreview');
    if (!slotsPreview) return;
    
    const activeSlots = boxes.filter(box => box.activated && box.isActiveInNFT);
    
    if (activeSlots.length === 0) {
        slotsPreview.innerHTML = '<span class="no-slots">No Active Slots</span>';
        return;
    }
    
    let html = '';
    activeSlots.forEach(box => {
        let slotClass = box.name.toLowerCase().replace(' ', '-').replace('pro', 'pro');
        let displayName = box.name.replace('PRO', 'P');
        
        html += `<div class="slot-preview-icon ${slotClass}" title="${box.name}">${displayName}</div>`;
    });
    
    slotsPreview.innerHTML = html;
}

// ========== NFT ‡§∏‡•ç‡§ü‡•à‡§ü‡•ç‡§∏ ‡§Ö‡§™‡§°‡•á‡§ü ==========
function updateNFTStats() {
    let activeNFTIncome = 0;
    boxes.forEach(box => {
        if (box.activated && box.isActiveInNFT) {
            activeNFTIncome += box.income;
        }
    });
    
    document.getElementById('incomeDisplay').innerText = Math.round(activeNFTIncome).toLocaleString() + ' IGT';
    updateSlotsPreview();
    document.getElementById('walletDisplay').innerText = 'wallet';
}

// ========== ‡§∏‡§ø‡§∏‡•ç‡§ü‡§Æ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®‡•ç‡§∏ ==========
function initializeMatrices() {
    let wrapper = document.getElementById('wrapper');
    wrapper.innerHTML = '';
    boxes = [];
    totalIncome = 0;
    currentSlotToBuy = 0;

    for (let i = 0; i < configs.length; i++) {
        createMatrix(i);
    }
    
    unlockSlot(0);
    updateStats();
    updateSlotsPreview();
}

function createMatrix(slotIndex) {
    let wrapper = document.getElementById('wrapper');
    let config = configs[slotIndex];
    let rules = incomeRules[config.name];
    let subscriptionPrice = Math.round(config.price * 0.1);

    let slot = document.createElement('div');
    slot.className = 'slot-card';
    slot.id = `slot-${slotIndex}`;

    slot.innerHTML = `
        <div class="slot-header">
            <span class="slot-name">${config.name}</span>
            <span class="slot-price">${config.price.toLocaleString()} IGT</span>
        </div>
        <div class="matrix-levels" id="levels-${slotIndex}"></div>
        <div class="mining-info" id="mining-${slotIndex}" style="display: none;">
            <div class="mining-display" id="mining-display-${slotIndex}">
                <span class="mining-item">üí∞ <span id="bgw-${slotIndex}">0.0000</span></span>
            </div>
        </div>
        <div class="slot-footer">
            <span class="slot-income" id="income-${slotIndex}">Income: 0 IGT</span>
            <span class="recycle-badge" id="recycle-${slotIndex}"><span>üîÑ</span> 0</span>
        </div>
        <div class="slot-actions">
            <button class="buy-btn" id="buy-${slotIndex}">üí≥ ‡§ñ‡§∞‡•Ä‡§¶‡•á‡§Ç (${config.price + subscriptionPrice} IGT)</button>
            <button class="add-member-btn" id="add-${slotIndex}" disabled>‚ûï ‡§Æ‡•á‡§Ç‡§¨‡§∞</button>
        </div>
        <button class="active-nft-btn" id="activeNFT-${slotIndex}" style="display: none;">
            ‚ö° Active in Passport NFT
        </button>
        <button class="extra-sub-btn" id="extra-${slotIndex}" style="display: none;" disabled>‚ú® Extra Asset (${subscriptionPrice} IGT)</button>
    `;

    wrapper.appendChild(slot);

    let levelsDiv = document.getElementById(`levels-${slotIndex}`);
    config.levels.forEach((nodeCount, levelIndex) => {
        let levelRow = document.createElement('div');
        levelRow.className = 'level-row';
        levelRow.setAttribute('data-level', levelIndex);
        levelRow.innerHTML = `
            <div class="level-label">L${levelIndex + 1}</div>
            <div class="nodes" id="nodes-${slotIndex}-${levelIndex}"></div>
        `;
        levelsDiv.appendChild(levelRow);

        let nodesDiv = document.getElementById(`nodes-${slotIndex}-${levelIndex}`);
        for (let pos = 0; pos < nodeCount; pos++) {
            let node = document.createElement('div');
            node.className = 'node tooltip';
            node.dataset.slot = slotIndex;
            node.dataset.level = levelIndex;
            node.dataset.position = pos;
            node.dataset.total = nodeCount;
            
            if (levelIndex === 0 && pos === 0) {
                node.innerText = 'YOU';
                node.classList.add('you-node');
            }

            let tooltip = document.createElement('span');
            tooltip.className = 'tooltip-text';
            
            let percent = rules[levelIndex] || 0;
            let isLast = (pos === nodeCount - 1);
            let finalPercent = isLast ? 0 : percent;
            
            tooltip.innerText = `L${levelIndex + 1} P${pos + 1} | ${finalPercent}% Income`;
            node.appendChild(tooltip);
            nodesDiv.appendChild(node);
        }
    });

    let nodes = [];
    for (let l = 0; l < config.levels.length; l++) {
        for (let p = 0; p < config.levels[l]; p++) {
            nodes.push(document.querySelector(`#nodes-${slotIndex}-${l} .node:nth-child(${p + 1})`));
        }
    }

    boxes.push({
        slotIndex: slotIndex,
        name: config.name,
        nodes: nodes,
        currentIndex: 1,
        memberCounter: 1,
        income: 0,
        recycleCount: 0,
        price: config.price,
        subscriptionPrice: subscriptionPrice,
        rules: rules,
        activated: false,
        isActiveInNFT: false,
        mainAsset: null,
        extraAsset: null,
        bgw: 0,
        assetAmount: 0,
        extraAmount: 0,
        miningInterval: null
    });

    document.getElementById(`buy-${slotIndex}`).addEventListener('click', () => buySlot(slotIndex));
    document.getElementById(`add-${slotIndex}`).addEventListener('click', () => addMemberToSlot(slotIndex));
    document.getElementById(`activeNFT-${slotIndex}`).addEventListener('click', () => activateSlotInNFT(slotIndex));
    document.getElementById(`extra-${slotIndex}`).addEventListener('click', () => openExtraPopup(slotIndex));
}

function unlockSlot(index) {
    let slot = document.getElementById(`slot-${index}`);
    if (slot) slot.classList.add('activated');
}

function buySlot(index) {
    if (index !== currentSlotToBuy) {
        alert(`‚ö†Ô∏è ‡§™‡§π‡§≤‡•á ${configs[currentSlotToBuy].name} ‡§ñ‡§∞‡•Ä‡§¶‡•á‡§Ç!`);
        return;
    }
    
    let box = boxes[index];
    if (box.activated) return;
    
    let totalPrice = box.price + box.subscriptionPrice;
    
    if (!confirm(`${box.name} ‡§ñ‡§∞‡•Ä‡§¶‡•á‡§Ç?\n‡§ï‡•Ä‡§Æ‡§§: ${totalPrice} IGT`)) return;
    
    box.activated = true;
    pendingBuySlot = index;
    selectedPopupAsset = null;
    
    document.getElementById('assetPopupSlot').innerText = box.name;
    document.getElementById('assetPopupPrice').innerText = `‡§∏‡•ç‡§≤‡•â‡§ü ‡§Æ‡•Ç‡§≤‡•ç‡§Ø: ${box.price} IGT`;
    document.getElementById('assetPopupSub').innerText = `‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® (10%): ${box.subscriptionPrice} IGT`;
    document.getElementById('assetPopupTotal').innerText = `‡§ï‡•Å‡§≤ ‡§≠‡•Å‡§ó‡§§‡§æ‡§®: ${totalPrice} IGT`;
    
    document.querySelectorAll('.asset-option-popup').forEach(opt => opt.classList.remove('selected'));
    document.getElementById('assetPopup').style.display = 'flex';
}

function selectAssetForPopup(asset, event) {
    selectedPopupAsset = asset;
    document.querySelectorAll('.asset-option-popup').forEach(opt => opt.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
}

function confirmAssetSelection() {
    if (pendingBuySlot === null) return;
    
    let index = pendingBuySlot;
    let box = boxes[index];
    
    box.mainAsset = selectedPopupAsset || 'bgw';
    
    document.getElementById(`slot-${index}`).classList.add('activated');
    document.getElementById(`add-${index}`).disabled = false;
    document.getElementById(`buy-${index}`).classList.add('hidden');
    document.getElementById(`mining-${index}`).style.display = 'flex';
    
    const activeBtn = document.getElementById(`activeNFT-${index}`);
    activeBtn.style.display = 'block';
    activeBtn.disabled = false;
    
    const extraBtn = document.getElementById(`extra-${index}`);
    extraBtn.style.display = 'block';
    extraBtn.disabled = false;
    
    startMining(index);
    
    if (index + 1 < boxes.length) unlockSlot(index + 1);
    
    currentSlotToBuy++;
    updateStats();
    closeAssetPopup();
}

function closeAssetPopup() {
    document.getElementById('assetPopup').style.display = 'none';
    if (pendingBuySlot !== null && !boxes[pendingBuySlot].mainAsset) {
        boxes[pendingBuySlot].activated = false;
    }
    pendingBuySlot = null;
    selectedPopupAsset = null;
}

function startMining(index) {
    let box = boxes[index];
    if (box.miningInterval) clearInterval(box.miningInterval);
    
    box.miningInterval = setInterval(() => {
        if (!box.activated) return;
        
        let speed = 1 + (index * 0.1);
        
        if (!box.mainAsset || box.mainAsset === 'bgw') {
            box.bgw += 0.0001 * speed;
        } else {
            box.assetAmount += 0.0001 * speed;
        }
        
        if (box.extraAsset) {
            if (box.extraAsset === 'bgw') box.bgw += 0.0001 * speed;
            else if (box.extraAsset === box.mainAsset) box.assetAmount += 0.0001 * speed;
            else box.extraAmount += 0.0001 * speed;
        }
        
        let displayDiv = document.getElementById(`mining-display-${index}`);
        if (displayDiv) {
            let displayHTML = '';
            if (!box.mainAsset || box.mainAsset === 'bgw') {
                displayHTML += `<span class="mining-item">üí∞ <span>${box.bgw.toFixed(4)}</span></span>`;
            } else {
                displayHTML += `<span class="mining-item">${assetEmojis[box.mainAsset]} <span>${box.assetAmount.toFixed(4)}</span></span>`;
            }
            
            if (box.extraAsset) {
                if (box.extraAsset === 'bgw') {
                    displayHTML += `<span class="mining-item">üí∞ <span>${box.bgw.toFixed(4)}</span></span>`;
                } else if (box.extraAsset === box.mainAsset) {
                    displayHTML += `<span class="mining-item">${assetEmojis[box.extraAsset]} <span>${box.assetAmount.toFixed(4)}</span></span>`;
                } else {
                    displayHTML += `<span class="mining-item">${assetEmojis[box.extraAsset]} <span>${box.extraAmount.toFixed(4)}</span></span>`;
                }
            }
            displayDiv.innerHTML = displayHTML;
        }
        
        updateNFTStats();
    }, 1000);
}

function activateSlotInNFT(index) {
    let box = boxes[index];
    if (!box.activated || box.isActiveInNFT) return;
    
    if (!confirm(`${box.name} ‡§ï‡•ã Passport NFT ‡§Æ‡•á‡§Ç Active ‡§ï‡§∞‡•á‡§Ç?`)) return;
    
    box.isActiveInNFT = true;
    
    const activeBtn = document.getElementById(`activeNFT-${index}`);
    activeBtn.style.display = 'none';
    
    updateSlotsPreview();
    
    alert(`‚úÖ ${box.name} ‡§Ö‡§¨ Passport NFT ‡§Æ‡•á‡§Ç Active ‡§π‡•à!`);
    
    updateNFTStats();
}

function openExtraPopup(index) {
    let box = boxes[index];
    if (!box.activated) return;
    
    currentExtraSlot = index;
    selectedExtraAsset = null;
    
    document.getElementById('popup-slot-name').innerText = box.name;
    document.getElementById('popup-slot-price').innerText = `‡§∏‡•ç‡§≤‡•â‡§ü ‡§Æ‡•Ç‡§≤‡•ç‡§Ø: ${box.price} IGT`;
    document.getElementById('popup-sub-price').innerText = `‡§∏‡§¨‡•ç‡§∏‡§ï‡•ç‡§∞‡§ø‡§™‡•ç‡§∂‡§® (10%): ${box.subscriptionPrice} IGT`;
    
    let currentAssetText = (!box.mainAsset || box.mainAsset === 'bgw') ? 'üí∞ BGW' : `${assetEmojis[box.mainAsset]} ${assetNames[box.mainAsset]}`;
    document.getElementById('popup-current-asset').innerHTML = `‡§Æ‡•å‡§ú‡•Ç‡§¶‡§æ ‡§è‡§∏‡•á‡§ü: ${currentAssetText}`;
    
    let allAssets = ['bgw', 'gold', 'silver', 'platinum'];
    let availableAssets = allAssets.filter(a => a !== box.mainAsset && a !== box.extraAsset);
    
    let container = document.getElementById('extraAssetContainer');
    container.innerHTML = '';
    
    availableAssets.forEach(asset => {
        let div = document.createElement('div');
        div.className = 'extra-asset-item';
        div.setAttribute('onclick', `selectExtraAsset('${asset}', event)`);
        div.innerHTML = `
            <div class="asset-radio"></div>
            <span class="asset-icon">${assetEmojis[asset]}</span>
            <span class="asset-name">${assetNames[asset]}</span>
            <span style="margin-left: auto; color: #2563eb; font-weight: 600;">${box.subscriptionPrice} IGT</span>
        `;
        container.appendChild(div);
    });
    
    document.getElementById('confirmExtraBtn').disabled = true;
    document.getElementById('subscriptionPopup').style.display = 'flex';
}

function selectExtraAsset(asset, event) {
    selectedExtraAsset = asset;
    document.querySelectorAll('.extra-asset-item').forEach(item => item.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    document.getElementById('confirmExtraBtn').disabled = false;
}

function confirmExtraAsset() {
    if (!selectedExtraAsset) {
        alert('‚ö†Ô∏è ‡§ï‡•ã‡§à ‡§è‡§∏‡•á‡§ü ‡§ö‡•Å‡§®‡•á‡§Ç!');
        return;
    }
    
    let box = boxes[currentExtraSlot];
    
    if (!confirm(`${box.subscriptionPrice} IGT ‡§Æ‡•á‡§Ç ${assetNames[selectedExtraAsset]} ‡§ö‡•Å‡§®‡•á‡§Ç?`)) return;
    
    box.extraAsset = selectedExtraAsset;
    
    if (selectedExtraAsset === 'bgw') box.bgw = 0;
    else if (selectedExtraAsset !== box.mainAsset) box.extraAmount = 0;
    
    alert(`‚úÖ ${assetNames[selectedExtraAsset]} ‡§Æ‡§æ‡§á‡§®‡§ø‡§Ç‡§ó ‡§∂‡•Å‡§∞‡•Ç!`);
    closeExtraPopup();
}

function closeExtraPopup() {
    document.getElementById('subscriptionPopup').style.display = 'none';
    currentExtraSlot = null;
    selectedExtraAsset = null;
}

function addMemberToSlot(index) {
    let box = boxes[index];
    if (!box.activated || box.currentIndex >= box.nodes.length) return;
    
    let node = box.nodes[box.currentIndex];
    
    node.innerText = box.memberCounter;
    box.memberCounter++;
    
    node.classList.add('active');
    
    let level = parseInt(node.dataset.level);
    let position = parseInt(node.dataset.position);
    let total = parseInt(node.dataset.total);
    
    let percent = box.rules[level] || 0;
    let isLast = (position === total - 1);
    let finalPercent = isLast ? 0 : percent;
    
    let income = (box.price * finalPercent) / 100;
    box.income += income;
    
    if (box.isActiveInNFT) {
        totalIncome += income;
    }
    
    node.classList.remove('income-positive', 'income-zero');
    
    if (finalPercent > 0) {
        node.classList.add('income-positive');
    } else {
        node.classList.add('income-zero');
    }
    
    let tooltip = node.querySelector('.tooltip-text');
    if (tooltip) {
        tooltip.innerText = `L${level + 1} P${position + 1} | ${finalPercent}% Income`;
    }
    
    document.getElementById(`income-${box.slotIndex}`).innerText = 
        `Income: ${Math.round(box.income).toLocaleString()} IGT`;
    
    box.currentIndex++;
    
    if (box.currentIndex >= box.nodes.length) {
        box.recycleCount++;
        document.getElementById(`recycle-${box.slotIndex}`).innerHTML = 
            `<span>üîÑ</span> ${box.recycleCount}`;

        setTimeout(() => {
            for (let j = 1; j < box.nodes.length; j++) {
                if (box.nodes[j]) {
                    box.nodes[j].innerText = '';
                    box.nodes[j].classList.remove('active', 'income-positive', 'income-zero');
                    
                    let oldTooltip = box.nodes[j].querySelector('.tooltip-text');
                    if (oldTooltip) {
                        let lvl = parseInt(box.nodes[j].dataset.level);
                        let pos = parseInt(box.nodes[j].dataset.position);
                        let tot = parseInt(box.nodes[j].dataset.total);
                        let perc = box.rules[lvl] || 0;
                        let last = (pos === tot - 1);
                        let finalPerc = last ? 0 : perc;
                        oldTooltip.innerText = `L${lvl + 1} P${pos + 1} | ${finalPerc}% Income`;
                    }
                }
            }
            box.currentIndex = 1;
        }, 700);
    }
    
    updateStats();
}

function updateStats() {
    let activeCount = boxes.filter(b => b.activated).length;
    document.getElementById('totalIncome').innerText = Math.round(totalIncome).toLocaleString();
    document.getElementById('activeSlots').innerText = activeCount;
    
    let totalMembers = 0;
    boxes.forEach(box => {
        if (box.activated) {
            totalMembers += (box.memberCounter - 1);
        }
    });
    document.getElementById('totalMembers').innerText = totalMembers;
}
